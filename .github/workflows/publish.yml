name: Publish to npm

on:
    push:
        tags:
            - "v*" # æŽ¨é€ v å¼€å¤´çš„ tag æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆå¦‚ v1.0.0, v2.3.1ï¼‰
    # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
    workflow_dispatch:
        inputs:
            dry_run:
                description: "Dry run (ä¸å®žé™…å‘å¸ƒ)"
                required: false
                default: "false"
                type: boolean

jobs:
    publish:
        name: Publish Package
        runs-on: ubuntu-latest

        permissions:
            contents: read
            id-token: write # ç”¨äºŽ npm Trusted Publishers OIDC è®¤è¯

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"
                  # ä¸ä½¿ç”¨ registry-urlï¼Œé¿å…åˆ›å»º .npmrc å¹²æ‰° OIDC è®¤è¯

            - name: Install dependencies
              run: npm ci

            - name: Build CLI
              run: npm run build

            - name: Verify CLI works
              run: |
                  node bin/index.js --version
                  node bin/index.js --help

            - name: Publish to npm (Dry Run)
              # åªæœ‰æ‰‹åŠ¨è§¦å‘ä¸” dry_run ä¸º true æ—¶æ‰æ‰§è¡Œ Dry Run
              if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
              run: npm publish --dry-run --access public

            - name: Publish to npm
              # Tag æŽ¨é€æ—¶æ€»æ˜¯å‘å¸ƒï¼Œæ‰‹åŠ¨è§¦å‘æ—¶éœ€è¦ dry_run ä¸º false
              if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true') }}
              # ä½¿ç”¨ --provenance å¯ç”¨ OIDC è®¤è¯å’Œæ¥æºè¯æ˜Ž
              run: npm publish --access public --provenance

            - name: Create publish summary
              run: |
                  echo "## ðŸ“¦ Package Published!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Package:** \`@twotwoba/vv-cli\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Version:** \`$(node -p "require('./package.json').version")\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Install" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                  echo "npm install -g @twotwoba/vv-cli" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
