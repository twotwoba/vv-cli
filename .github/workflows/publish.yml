name: Publish to npm

on:
    release:
        types: [published]
    # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
    workflow_dispatch:
        inputs:
            dry_run:
                description: "Dry run (ä¸å®žé™…å‘å¸ƒ)"
                required: false
                default: "false"
                type: boolean

jobs:
    publish:
        name: Publish Package
        runs-on: ubuntu-latest

        permissions:
            contents: read
            id-token: write # ç”¨äºŽ npm Trusted Publishers OIDC è®¤è¯

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"
                  registry-url: "https://registry.npmjs.org"

            - name: Install dependencies
              run: npm ci

            - name: Build CLI
              run: npm run build

            - name: Verify CLI works
              run: |
                  node bin/index.js --version
                  node bin/index.js --help

            - name: Publish to npm (Dry Run)
              if: ${{ github.event.inputs.dry_run == 'true' }}
              run: npm publish --dry-run --access public

            - name: Publish to npm
              if: ${{ github.event.inputs.dry_run != 'true' }}
              # ä½¿ç”¨ Trusted Publishersï¼Œprovenance ä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œæ— éœ€ --provenance æ ‡å¿—
              run: npm publish --access public

            - name: Create publish summary
              run: |
                  echo "## ðŸ“¦ Package Published!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Package:** \`@twotwoba/vv-cli\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Version:** \`$(node -p "require('./package.json').version")\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Install" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                  echo "npm install -g @twotwoba/vv-cli" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
